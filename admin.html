<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>TANAW ¬∑ Admin Dashboard</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,1,0"/>
<link rel="stylesheet" href="style.css">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{min-height:100%;height:auto;font-family:'Inter',system-ui,sans-serif;background:#f5f5f5;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.admin-app{width:100%;max-width:430px;min-height:100dvh;margin:0 auto;display:flex;flex-direction:column;background:#f5f5f5;padding-bottom:40px;}
.login-screen{position:fixed;inset:0;z-index:1000;background:linear-gradient(135deg,#ef5a3c,#c94626);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;}
.login-screen.hidden{display:none;}
.login-logo{width:80px;height:80px;border-radius:24px;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:40px;margin-bottom:20px;overflow:hidden;}
.login-logo img{width:100%;height:100%;object-fit:cover;border-radius:24px;}
.login-screen h1{font-size:28px;font-weight:800;color:#fff;margin-bottom:4px;}
.login-screen p{font-size:14px;color:rgba(255,255,255,.75);margin-bottom:36px;}
.login-card{background:#fff;border-radius:24px;padding:24px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.login-card h2{font-size:18px;font-weight:700;margin-bottom:20px;color:#1a1a1a;}
.login-field{margin-bottom:14px;}
.login-field label{font-size:11px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px;}
.login-field input{width:100%;padding:12px 14px;border:1.5px solid #e8e8e8;border-radius:12px;font-size:14px;font-family:inherit;outline:none;background:#fafafa;}
.login-field input:focus{border-color:#ef5a3c;}
.login-err{font-size:13px;color:#d32f2f;margin-top:-6px;margin-bottom:10px;display:none;}
.login-err.show{display:block;}
.login-btn{width:100%;padding:14px;background:#ef5a3c;color:#fff;border:none;border-radius:14px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;margin-top:8px;}
.login-btn:active{background:#d44a2e;}
.admin-header{background:var(--primary);padding:14px 16px 12px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.admin-header-title span{font-size:11px;color:rgba(255,255,255,.65);font-weight:500;letter-spacing:.6px;text-transform:uppercase;display:block;}
.admin-header-title h2{font-size:20px;font-weight:700;color:#fff;margin:0;}
.logout-btn{background:rgba(255,255,255,.2);border:none;border-radius:12px;padding:8px 12px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px;}
.logout-btn .material-symbols-rounded{font-size:16px;}
.stats-row{display:flex;gap:10px;padding:16px 16px 8px;}
.stat-card{flex:1;background:#fff;border-radius:16px;padding:14px 12px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.05);}
.stat-num{font-size:28px;font-weight:800;color:var(--primary);}
.stat-label{font-size:11px;color:#999;font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-top:2px;}
.admin-tabs{display:flex;gap:0;margin:8px 16px;background:#fff;border-radius:14px;padding:4px;box-shadow:0 2px 8px rgba(0,0,0,.05);overflow-x:auto;scrollbar-width:none;}
.admin-tab{flex:1;padding:10px;border-radius:10px;border:none;background:none;font-size:13px;font-weight:600;color:#999;cursor:pointer;font-family:inherit;transition:all .2s;white-space:nowrap;}
.admin-tab.active{background:var(--primary);color:#fff;}
.admin-section{padding:0 16px 16px;display:none;}
.admin-section.active{display:block;}
.pending-card{background:#fff;border-radius:16px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden;border-left:4px solid #fbc02d;}
.pending-card-head{padding:14px 14px 10px;display:flex;align-items:flex-start;gap:12px;}
.pending-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.pending-info{flex:1;}
.pending-info h4{font-size:15px;font-weight:700;color:#1a1a1a;margin-bottom:3px;}
.pending-info p{font-size:12px;color:#777;line-height:1.4;}
.pending-info small{font-size:11px;color:#bbb;display:block;margin-top:3px;}
.pending-msg{padding:0 14px 10px;font-size:13px;color:#555;line-height:1.5;border-bottom:1px solid #f0f0f0;}
.pending-actions{display:flex;}
.pa-btn{flex:1;padding:12px;border:none;background:none;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:6px;transition:background .15s;}
.pa-btn .material-symbols-rounded{font-size:18px;}
.pa-btn.verify{color:#2e7d32;border-right:1px solid #f0f0f0;}
.pa-btn.verify:active{background:#e8f5e9;}
.pa-btn.reject{color:#d32f2f;}
.pa-btn.reject:active{background:#ffebee;}
.verified-card{background:#fff;border-radius:16px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.06);border-left:4px solid #2e7d32;}
.verified-card-inner{padding:14px 14px;display:flex;align-items:center;gap:12px;}
.vc-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.vc-info{flex:1;}
.vc-info h4{font-size:14px;font-weight:700;color:#1a1a1a;margin-bottom:2px;}
.vc-info p{font-size:12px;color:#999;}
.points-card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:10px;display:flex;align-items:center;gap:14px;}
.pts-rank{font-size:22px;font-weight:800;color:#ccc;width:32px;text-align:center;flex-shrink:0;}
.pts-rank.gold{color:#f9a825;} .pts-rank.silver{color:#9e9e9e;} .pts-rank.bronze{color:#8d6e63;}
.pts-avatar{width:44px;height:44px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;flex-shrink:0;}
.pts-name{flex:1;font-size:15px;font-weight:600;color:#1a1a1a;}
.pts-count{font-size:20px;font-weight:800;color:var(--primary);}
.pts-pts-label{font-size:11px;color:#999;text-align:right;}
.admin-empty{text-align:center;padding:40px 20px;color:#bbb;}
.admin-empty .material-symbols-rounded{font-size:52px;display:block;margin-bottom:10px;color:#ddd;}
.admin-empty p{font-size:14px;}
.section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:#999;padding:12px 0 8px;}
.dpwh-map-wrap{position:relative;border-radius:16px;overflow:hidden;margin-bottom:12px;box-shadow:0 4px 16px rgba(0,0,0,.12);}
#dpwhMap{width:100%;height:260px;background:#e8eaed;}
.dpwh-map-hint{font-size:12px;color:#999;margin-bottom:10px;padding:8px 12px;background:#fff;border-radius:10px;border-left:3px solid var(--primary);}
.dpwh-form{background:#fff;border-radius:16px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:12px;}
.dpwh-form h4{font-size:13px;font-weight:700;color:#1a1a1a;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px;}
.dpwh-input{width:100%;padding:10px 12px;border:1.5px solid #e8e8e8;border-radius:10px;font-size:14px;font-family:inherit;outline:none;margin-bottom:8px;background:#fafafa;}
.dpwh-input:focus{border-color:var(--primary);background:#fff;}
.dpwh-select{width:100%;padding:10px 12px;border:1.5px solid #e8e8e8;border-radius:10px;font-size:14px;font-family:inherit;outline:none;margin-bottom:8px;background:#fafafa;appearance:none;}
.dpwh-submit-btn{width:100%;padding:12px;background:var(--primary);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:8px;}
.dpwh-submit-btn .material-symbols-rounded{font-size:18px;}
.dpwh-submit-btn:active{background:#d44a2e;}
.dpwh-closure-card{background:#fff;border-radius:14px;padding:13px 14px;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.05);border-left:4px solid #d32f2f;display:flex;align-items:flex-start;gap:12px;}
.dpwh-closure-card.partial{border-left-color:#f57c00;}
.dpwh-closure-card.advisory{border-left-color:#1976d2;}
.dpwh-closure-icon{font-size:24px;flex-shrink:0;}
.dpwh-closure-info{flex:1;min-width:0;}
.dpwh-closure-info h5{font-size:14px;font-weight:700;color:#1a1a1a;margin-bottom:2px;}
.dpwh-closure-info p{font-size:12px;color:#777;margin-bottom:2px;}
.dpwh-closure-info small{font-size:11px;color:#bbb;}
.dpwh-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:50px;margin-bottom:4px;display:inline-block;}
.dpwh-badge.full{background:#ffebee;color:#d32f2f;}
.dpwh-badge.partial{background:#fff3e0;color:#e65100;}
.dpwh-badge.advisory{background:#e3f2fd;color:#1565c0;}
.dpwh-del-btn{background:#ffebee;border:none;border-radius:10px;padding:7px;cursor:pointer;flex-shrink:0;}
.dpwh-del-btn .material-symbols-rounded{font-size:18px;color:#d32f2f;}
#adminToast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(16px);
  background:#1a1a1a;color:#fff;padding:10px 20px;border-radius:50px;
  font-size:13px;font-weight:500;z-index:2000;opacity:0;
  transition:opacity .25s,transform .25s;pointer-events:none;white-space:nowrap;
}
#adminToast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<!-- Firebase SDKs (compat mode ‚Äî same as firebase-db.js uses) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="firebase-db.js"></script>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-logo"><img src="applogo.jpg" alt="logo"></div>
  <h1>TANAW</h1>
  <p>Admin Dashboard</p>
  <div class="login-card">
    <h2>Sign in to continue</h2>
    <div class="login-field">
      <label>Username</label>
      <input type="text" id="loginUser" placeholder="admin" autocomplete="off">
    </div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <div class="login-err" id="loginErr">Incorrect username or password.</div>
    <button class="login-btn" onclick="doLogin()">Sign In</button>
  </div>
</div>

<!-- DASHBOARD -->
<div class="admin-app" id="dashboard" style="display:none;">
  <header class="admin-header">
    <div class="admin-header-title">
      <span>Admin Panel</span>
      <h2>TANAW Dashboard</h2>
    </div>
    <button class="logout-btn" onclick="doLogout()">
      <span class="material-symbols-rounded">logout</span>Logout
    </button>
  </header>

  <div class="stats-row">
    <div class="stat-card"><div class="stat-num" id="statPending">0</div><div class="stat-label">Pending</div></div>
    <div class="stat-card"><div class="stat-num" id="statVerified">0</div><div class="stat-label">Verified</div></div>
    <div class="stat-card"><div class="stat-num" id="statPoints">0</div><div class="stat-label">Pts Given</div></div>
  </div>

  <div class="admin-tabs">
    <button class="admin-tab active" onclick="switchTab('pending',this)">‚è≥ Pending</button>
    <button class="admin-tab" onclick="switchTab('verified',this)">‚úÖ Verified</button>
    <button class="admin-tab" onclick="switchTab('points',this)">üèÜ Points</button>
    <button class="admin-tab" onclick="switchTab('dpwh',this)">üöß DPWH</button>
  </div>

  <div class="admin-section active" id="tab-pending">
    <div class="section-title">Awaiting Verification</div>
    <div id="pendingList"></div>
  </div>

  <div class="admin-section" id="tab-verified">
    <div class="section-title">Verified &amp; Live on Feed</div>
    <div id="verifiedList"></div>
  </div>

  <div class="admin-section" id="tab-points">
    <div class="section-title">Reporter Points (Firebase)</div>
    <div id="pointsList"></div>
  </div>

  <div class="admin-section" id="tab-dpwh">
    <div class="section-title">DPWH Road Management</div>
    <div class="dpwh-map-hint">üìç Tap anywhere on the map to pin a road closure or advisory. Fill in the details below and publish.</div>
    <div class="dpwh-map-wrap"><div id="dpwhMap"></div></div>
    <div class="dpwh-form">
      <h4>üöß Add Road Closure / Advisory</h4>
      <input class="dpwh-input" id="dpwhRoadName" placeholder="Road / Street name" maxlength="80">
      <input class="dpwh-input" id="dpwhReason" placeholder="Reason (e.g. Pavement repair, flooding)" maxlength="120">
      <select class="dpwh-select" id="dpwhType">
        <option value="full">‚õî Full Road Closure</option>
        <option value="partial">‚ö†Ô∏è Partial Closure / One Lane</option>
        <option value="advisory">‚ÑπÔ∏è Advisory / Slow Down</option>
      </select>
      <label style="font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px;">‚è± Closure Duration</label>
      <div style="display:flex;gap:8px;margin-bottom:8px;">
        <select class="dpwh-select" id="dpwhDurNum" style="flex:1;margin-bottom:0;">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="12">12</option><option value="24">24</option>
          <option value="48">48</option>
        </select>
        <select class="dpwh-select" id="dpwhDurUnit" style="flex:2;margin-bottom:0;">
          <option value="hours">Hours</option>
          <option value="days">Days</option>
          <option value="weeks">Weeks</option>
        </select>
      </div>
      <input class="dpwh-input" id="dpwhLat" placeholder="Lat (auto-filled on map tap)" readonly>
      <input class="dpwh-input" id="dpwhLng" placeholder="Lng (auto-filled on map tap)" readonly>
      <button class="dpwh-submit-btn" onclick="publishDpwh()">
        <span class="material-symbols-rounded">publish</span> Publish to Main Map
      </button>
    </div>
    <div class="section-title">Active Closures &amp; Advisories</div>
    <div id="dpwhList"></div>
  </div>
</div>

<div id="adminToast"></div>

<script>
/* ‚îÄ‚îÄ CREDENTIALS ‚îÄ‚îÄ */
const ADMIN_USER = "admin";
const ADMIN_PASS = "tanaw2025";

/* ‚îÄ‚îÄ LOCAL CACHES ‚îÄ‚îÄ */
let _pending  = [];
let _verified = [];
let _ptsLog   = {};
let _dpwh     = [];

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
function doLogin() {
  const u=document.getElementById("loginUser").value.trim();
  const p=document.getElementById("loginPass").value;
  if (u===ADMIN_USER && p===ADMIN_PASS) {
    sessionStorage.setItem("tanaw_admin","1");
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("dashboard").style.cssText="display:flex;flex-direction:column;";
    startListeners();
  } else {
    document.getElementById("loginErr").classList.add("show");
    document.getElementById("loginPass").value="";
  }
}
document.getElementById("loginPass")?.addEventListener("keydown",e=>{if(e.key==="Enter")doLogin();});
function doLogout(){sessionStorage.removeItem("tanaw_admin");location.reload();}
if (sessionStorage.getItem("tanaw_admin")==="1"){
  document.getElementById("loginScreen").classList.add("hidden");
  document.getElementById("dashboard").style.cssText="display:flex;flex-direction:column;";
  startListeners();
}

/* ‚îÄ‚îÄ FIREBASE LISTENERS ‚îÄ‚îÄ */
function startListeners(){
  fbListen(REFS.pending,  arr=>{_pending=arr;  renderStats();renderPending();});
  fbListen(REFS.alerts,   arr=>{_verified=arr; renderStats();renderVerified();});
  fbListen(REFS.points,   snap=>{
    // points stored as points_log/{reporter}: count
    _ptsLog = {};
    if(snap && snap.length){
      snap.forEach(item=>{ _ptsLog[item._key]=(item.count||0); });
    } else {
      REFS.points.once("value").then(s=>{ _ptsLog=s.val()||{}; renderPoints(); });
    }
    renderPoints();
  });
  fbListen(REFS.dpwh, arr=>{_dpwh=arr; renderDpwhList();});
}

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
const TYPE_META={
  Roadwork:{emoji:"üöß",bg:"#fff8e1"},Traffic:{emoji:"üö¶",bg:"#fff9e6"},
  Flood:{emoji:"üåä",bg:"#e3f2fd"},Crash:{emoji:"üöó",bg:"#ffebee"},
  Fire:{emoji:"üî•",bg:"#fff3e0"},Earthquake:{emoji:"üåè",bg:"#efebe9"},
  Typhoon:{emoji:"üåÄ",bg:"#e1f5fe"},Landslide:{emoji:"ü™®",bg:"#efebe9"},
  Others:{emoji:"‚ö†Ô∏è",bg:"#f5f5f5"},
};
function timeAgo(t){
  const m=Math.floor((Date.now()-t)/60000);
  if(m<1)return"Just now";if(m<60)return m+" min ago";
  const h=Math.floor(m/60);return h<24?h+"h ago":Math.floor(h/24)+"d ago";
}
function escHtml(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function toast(msg){
  const t=document.getElementById("adminToast");
  t.textContent=msg;t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),3000);
}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
function switchTab(name,el){
  document.querySelectorAll(".admin-tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".admin-section").forEach(s=>s.classList.remove("active"));
  el.classList.add("active");
  document.getElementById("tab-"+name).classList.add("active");
  if(name==="dpwh"){renderDpwhList();setTimeout(initDpwhMap,100);}
}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
function renderStats(){
  document.getElementById("statPending").textContent  = _pending.length;
  document.getElementById("statVerified").textContent = _verified.length;
  const totalPts = Object.values(_ptsLog).reduce((a,b)=>a+(b||0),0);
  document.getElementById("statPoints").textContent   = totalPts;
}

/* ‚îÄ‚îÄ PENDING ‚îÄ‚îÄ */
function renderPending(){
  const list=document.getElementById("pendingList");
  if(!_pending.length){
    list.innerHTML=`<div class="admin-empty"><span class="material-symbols-rounded">check_circle</span><p>No pending reports.<br>All caught up!</p></div>`;
    return;
  }
  list.innerHTML=_pending.map(r=>{
    const meta=TYPE_META[r.type]||TYPE_META.Others;
    return `<div class="pending-card">
      <div class="pending-card-head">
        <div class="pending-icon" style="background:${meta.bg}">${meta.emoji}</div>
        <div class="pending-info">
          <h4>${escHtml(r.type)}</h4>
          <p>üìç ${escHtml(r.area||"Unknown location")}</p>
          <small>üïê ${timeAgo(r.time)}</small>
        </div>
      </div>
      ${r.message&&r.message!=="User report"?`<div class="pending-msg">"${escHtml(r.message)}"</div>`:""}
      <div class="pending-actions">
        <button class="pa-btn verify" onclick="verifyReport('${r._key}')">
          <span class="material-symbols-rounded">verified</span> Verify &amp; Publish
        </button>
        <button class="pa-btn reject" onclick="rejectReport('${r._key}')">
          <span class="material-symbols-rounded">cancel</span> Reject
        </button>
      </div>
    </div>`;
  }).join("");
}

/* ‚îÄ‚îÄ VERIFY ‚îÄ‚îÄ */
async function verifyReport(key){
  const report=_pending.find(p=>p._key===key); if(!report)return;

  // Move from pending ‚Üí alerts
  const verified={...report, _key:undefined, verified:true, verifiedAt:Date.now(), likes:report.likes||0, comments:report.comments||{}};
  delete verified._key;

  await fbPush(REFS.alerts, verified);
  await fbRemove(REFS.pending, key);

  // Award point in Firebase
  const reporter=report.reportedBy||"user";
  const ptSnap=await REFS.points.child(reporter).once("value");
  const current=(ptSnap.val()&&ptSnap.val().count)||0;
  await REFS.points.child(reporter).set({ count: current+1 });

  toast("‚úÖ Report verified! +1 point awarded");
}

/* ‚îÄ‚îÄ REJECT ‚îÄ‚îÄ */
async function rejectReport(key){
  if(!confirm("Reject and delete this report?"))return;
  await fbRemove(REFS.pending, key);
  toast("üóëÔ∏è Report rejected");
}

/* ‚îÄ‚îÄ VERIFIED LIST ‚îÄ‚îÄ */
function renderVerified(){
  const list=document.getElementById("verifiedList");
  const show=_verified.filter(a=>!a.dpwh);
  if(!show.length){
    list.innerHTML=`<div class="admin-empty"><span class="material-symbols-rounded">dynamic_feed</span><p>No verified incidents yet.</p></div>`;
    return;
  }
  list.innerHTML=show.map(a=>{
    const meta=TYPE_META[a.type]||TYPE_META.Others;
    const isResolved=!!a.resolvedAt;
    const msLeft=isResolved?Math.max(0,10*60*1000-(Date.now()-a.resolvedAt)):0;
    const minLeft=Math.ceil(msLeft/60000);
    return `<div class="verified-card" style="border-left-color:${isResolved?"#2e7d32":""}">
      <div class="verified-card-inner">
        <div class="vc-icon" style="background:${isResolved?"#e8f5e9":meta.bg}">${isResolved?"‚úÖ":meta.emoji}</div>
        <div class="vc-info">
          <h4>${escHtml(a.type)} ${isResolved?`<span style="font-size:10px;background:#e8f5e9;color:#2e7d32;padding:2px 7px;border-radius:50px;font-weight:700;">Resolved</span>`:""}</h4>
          <p>${escHtml(a.area||"Unknown")} ¬∑ ‚ù§Ô∏è ${a.likes||0} ¬∑ ${timeAgo(a.time)}</p>
          ${isResolved?`<small style="color:#f57c00;font-weight:600;">‚è± Auto-removes in ~${minLeft} min</small>`:""}
        </div>
        <button onclick="toggleResolved('${a._key}')"
          style="background:${isResolved?"#2e7d32":"#e8f5e9"};border:none;border-radius:10px;padding:8px;cursor:pointer;margin-right:4px;flex-shrink:0;">
          <span class="material-symbols-rounded" style="font-size:18px;color:${isResolved?"#fff":"#2e7d32"};">check_circle</span>
        </button>
        <button style="background:#ffebee;border:none;border-radius:10px;padding:8px;cursor:pointer;flex-shrink:0;" onclick="removeVerified('${a._key}')">
          <span class="material-symbols-rounded" style="font-size:18px;color:#d32f2f;">delete</span>
        </button>
      </div>
    </div>`;
  }).join("");
}

async function toggleResolved(key){
  const a=_verified.find(x=>x._key===key); if(!a)return;
  if(a.resolvedAt){
    await REFS.alerts.child(key).update({resolvedAt:null});
    toast("‚Ü©Ô∏è Marked as unresolved");
  } else {
    await REFS.alerts.child(key).update({resolvedAt:Date.now()});
    toast("‚úÖ Marked as resolved ‚Äî auto-removes in 10 min");
  }
}

async function removeVerified(key){
  if(!confirm("Remove this verified report from the live feed?"))return;
  await fbRemove(REFS.alerts,key);
  toast("üóëÔ∏è Removed from feed");
}

/* ‚îÄ‚îÄ POINTS ‚îÄ‚îÄ */
function renderPoints(){
  const list=document.getElementById("pointsList");
  const entries=Object.entries(_ptsLog).sort((a,b)=>b[1]-a[1]);
  if(!entries.length){
    list.innerHTML=`<div class="admin-empty"><span class="material-symbols-rounded">emoji_events</span><p>No points awarded yet.</p></div>`;
    return;
  }
  const rankClass=i=>i===0?"gold":i===1?"silver":i===2?"bronze":"";
  const rankIcon =i=>i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":"#"+(i+1);
  list.innerHTML=entries.map(([name,pts],i)=>`
    <div class="points-card">
      <div class="pts-rank ${rankClass(i)}">${rankIcon(i)}</div>
      <div class="pts-avatar">${name[0].toUpperCase()}</div>
      <div class="pts-name">${escHtml(name)}</div>
      <div><div class="pts-count">${pts}</div><div class="pts-pts-label">pts</div></div>
    </div>`).join("");
}

/* ‚îÄ‚îÄ DPWH ‚îÄ‚îÄ */
let dpwhMap,dpwhMarker,dpwhClosureMarkers=[];

function initDpwhMap(){
  if(dpwhMap)return;
  dpwhMap=new google.maps.Map(document.getElementById("dpwhMap"),{
    center:{lat:13.6218,lng:123.1945},zoom:14,
    mapTypeControl:false,streetViewControl:false,fullscreenControl:false,zoomControl:true
  });
  dpwhMap.addListener("click",e=>{
    const lat=e.latLng.lat().toFixed(6),lng=e.latLng.lng().toFixed(6);
    document.getElementById("dpwhLat").value=lat;
    document.getElementById("dpwhLng").value=lng;
    if(dpwhMarker)dpwhMarker.setMap(null);
    dpwhMarker=new google.maps.Marker({position:e.latLng,map:dpwhMap,title:"Pinned location",
      icon:{path:google.maps.SymbolPath.CIRCLE,scale:10,fillColor:"#ef5a3c",fillOpacity:1,strokeColor:"#fff",strokeWeight:2}
    });
  });
  renderDpwhMapMarkers();
}

function renderDpwhMapMarkers(){
  if(!dpwhMap)return;
  dpwhClosureMarkers.forEach(m=>m.setMap(null));
  dpwhClosureMarkers=[];
  const iconColor={full:"#d32f2f",partial:"#f57c00",advisory:"#1976d2"};
  const iconEmoji={full:"‚õî",partial:"‚ö†Ô∏è",advisory:"‚ÑπÔ∏è"};
  _dpwh.forEach(c=>{
    if(!c.lat||!c.lng)return;
    const marker=new google.maps.Marker({
      position:{lat:parseFloat(c.lat),lng:parseFloat(c.lng)},map:dpwhMap,title:c.road,
      icon:{path:google.maps.SymbolPath.CIRCLE,scale:12,fillColor:iconColor[c.type]||"#d32f2f",fillOpacity:1,strokeColor:"#fff",strokeWeight:2},
      label:{text:iconEmoji[c.type]||"üöß",fontSize:"14px"}
    });
    const info=new google.maps.InfoWindow({content:`<div style="font-family:system-ui;padding:4px 2px;max-width:200px">
      <strong style="font-size:13px">${c.road}</strong><br>
      <span style="font-size:12px;color:#555">${c.reason}</span><br>
      <span style="font-size:11px;color:#999">${c.duration}</span>
    </div>`});
    marker.addListener("click",()=>info.open(dpwhMap,marker));
    dpwhClosureMarkers.push(marker);
  });
}

async function publishDpwh(){
  const road   =document.getElementById("dpwhRoadName").value.trim();
  const reason =document.getElementById("dpwhReason").value.trim();
  const type   =document.getElementById("dpwhType").value;
  const durNum =parseInt(document.getElementById("dpwhDurNum").value);
  const durUnit=document.getElementById("dpwhDurUnit").value;
  const lat    =document.getElementById("dpwhLat").value;
  const lng    =document.getElementById("dpwhLng").value;
  if(!road||!lat||!lng){toast("‚ö†Ô∏è Tap the map to pin a location and enter a road name.");return;}
  const unitMs={hours:3600000,days:86400000,weeks:604800000};
  const durationMs=durNum*unitMs[durUnit];
  const expiresAt=Date.now()+durationMs;
  const durationLabel=`${durNum} ${durUnit}`;
  const closure={id:Date.now().toString(),road,reason,type,durationLabel,durationMs,expiresAt,lat,lng,time:Date.now()};
  await fbPush(REFS.dpwh,closure);

  // Also push to main alerts
  await fbPush(REFS.alerts,{
    id:"dpwh_"+closure.id,type:"Roadwork",area:road,
    message:`[DPWH] ${reason} ¬∑ ${durationLabel}`,
    lat:parseFloat(lat),lng:parseFloat(lng),
    time:Date.now(),verified:true,likes:0,comments:{},
    dpwh:true,expiresAt
  });

  ["dpwhRoadName","dpwhReason","dpwhLat","dpwhLng"].forEach(id=>document.getElementById(id).value="");
  if(dpwhMarker){dpwhMarker.setMap(null);dpwhMarker=null;}
  toast(`üöß Closure published! Auto-expires in ${durationLabel}`);
  renderDpwhMapMarkers();
}

async function removeDpwh(key,expired){
  if(!expired&&!confirm("Remove this closure?"))return;
  const closure=_dpwh.find(c=>c._key===key);
  await fbRemove(REFS.dpwh,key);

  // Remove from alerts too
  const alertsSnap=await REFS.alerts.once("value");
  if(alertsSnap.exists()){
    const obj=alertsSnap.val();
    Object.entries(obj).forEach(([k,v])=>{
      if(v.dpwh&&v.id==="dpwh_"+(closure?.id||""))REFS.alerts.child(k).remove();
    });
  }

  // Push road open announcement
  if(closure){
    await fbPush(REFS.announcements,{
      type:"road_open",title:"üü¢ Road Now Open",
      message:`${closure.road} is now open! DPWH closure has ended.`,
      time:Date.now()
    });
  }
  if(!expired)toast("üóëÔ∏è Closure removed");
  else toast(`üü¢ ${closure?.road||"Road"} is now open ‚Äî announcement sent!`);
  renderDpwhMapMarkers();
}

function renderDpwhList(){
  const list=document.getElementById("dpwhList"); if(!list)return;
  const now=Date.now();
  // Auto-expire
  _dpwh.forEach(c=>{if(c.expiresAt&&now>=c.expiresAt)removeDpwh(c._key,true);});
  const active=_dpwh.filter(c=>!c.expiresAt||now<c.expiresAt);
  if(!active.length){
    list.innerHTML=`<div class="admin-empty"><span class="material-symbols-rounded">traffic</span><p>No active closures.<br>Tap the map to add one.</p></div>`;
    return;
  }
  const typeLabel={full:"Full Closure",partial:"Partial Closure",advisory:"Advisory"};
  const typeIcon ={full:"‚õî",partial:"‚ö†Ô∏è",advisory:"‚ÑπÔ∏è"};
  list.innerHTML=active.map(c=>{
    const msLeft=c.expiresAt?Math.max(0,c.expiresAt-now):null;
    let timeLeft="";
    if(msLeft!==null){
      if(msLeft<3600000)timeLeft=`‚è± Expires in ${Math.ceil(msLeft/60000)} min`;
      else if(msLeft<86400000)timeLeft=`‚è± Expires in ${Math.ceil(msLeft/3600000)}h`;
      else timeLeft=`‚è± Expires in ${Math.ceil(msLeft/86400000)}d`;
    }
    return `<div class="dpwh-closure-card ${c.type}">
      <div class="dpwh-closure-icon">${typeIcon[c.type]||"üöß"}</div>
      <div class="dpwh-closure-info">
        <span class="dpwh-badge ${c.type}">${typeLabel[c.type]||c.type}</span>
        <h5>${escHtml(c.road)}</h5>
        <p>${escHtml(c.reason||"No reason specified")}</p>
        <small>üìÖ ${escHtml(c.durationLabel||"Until further notice")} ¬∑ üïê ${timeAgo(c.time)}</small>
        ${timeLeft?`<br><small style="color:#f57c00;font-weight:600;">${timeLeft}</small>`:""}
      </div>
      <button class="dpwh-del-btn" onclick="removeDpwh('${c._key}',false)">
        <span class="material-symbols-rounded">delete</span>
      </button>
    </div>`;
  }).join("");
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao&libraries=places"></script>
</body>
</html>
